#!/usr/bin/perl

# Copyright (C) 2014 Mikhael Goikhman <migo@freeshell.org>

use strict;
use warnings;
use sigtrap qw(die untrapped normal-signals  stack-trace any error-signals);

use Getopt::Long qw(:config no_ignore_case bundling);
use POSIX qw(strftime);

use FindBin;
use lib "$FindBin::Bin/../lib";
use SMB::Client;

my $verbose = 0;
my $username = $ENV{USER} || $ENV{LOGNAME} || 'guest';

sub show_usage (;$) {
	my $is_error = shift || 0;
	my $out = $is_error ? \*STDERR : \*STDOUT;
	my $usage = qq{
		Usage: $0 [OPTIONS] //server/share
		Start a simple SMB client

		Options:
			-h --help            show this usage
			-v --verbose         print more messages
			-U --username u[%p]  SMB username and password (prompted if absent)
	};
	$usage =~ s/^\n//; $usage =~ s/^\t\t?//mg;
	print $out $usage;
	exit $is_error;
}

GetOptions(
	'h|help'       => sub { show_usage(0) },
	'v|verbose+'   => \$verbose,
	'U|username=s' => \$username,
) or show_usage(1);

my $share_uri = shift || '//localhost/users';

use Term::ReadLine;
my $term = Term::ReadLine->new('smb-client');
$term->MinLine(undef);  # no autohistory
my $OUT = $term->OUT || \*STDOUT;
my $history_filename = '.smb-client-history';
eval { $term->ReadHistory($history_filename) };
END { eval { $term->WriteHistory($history_filename) }; }
$Term::ReadLine::Gnu::Attribs{term_set} = [ "\033[1;36m", "\033[m", "\033[1;31m", "\033[m" ]
	if %Term::ReadLine::Gnu::Attribs;
@Term::ReadLine::TermCap::rl_term_set = ("\033[1;36m", "\033[m", "\033[1;31m", "\033[m")
	if @Term::ReadLine::TermCap::rl_term_set;

my @args;
sub prompt ($;$$) {
	my $message = shift;
	my $n_args = shift || 0;
	my $is_secret = shift;

	return shift @args if $n_args == -1 && @args;

	my $answer = $term->readline("$message ", '');
	print $OUT "\n";
	return unless defined $answer;
	$answer =~ s/^\s+|\s+$//g;
	$answer =~ s/\s+/ /g;
	$term->addhistory($answer) if $answer ne '' && !$is_secret;

	my @words = split(' ', $answer);
	if (@words > 1) {
		$answer = shift @words;
		push @args, shift @words while @words && $n_args--;
		warn "Extraneous words in input (@words) skipped\n" if @words;
	}

	return $answer;
}

my $password = $username =~ s/%(.*)$// ? $1 : undef;
$password //= prompt("Enter password for user '$username'", 0, 1);

my $client = SMB::Client->new(
	$share_uri,
	username => $username,
	password => $password,
	verbose  => $verbose,
);

my $tree = $client->connect
	or die "Failed to connect to $share_uri, aborting\n";

my %operations = (
	cd => sub {
		$tree->chdir(prompt("Directory to change to"));
	},
	del => sub {
		$tree->remove(prompt("File to remove"));
	},
	dir => sub {
		$tree->find(@args ? shift @args : '*');
	},
	help => sub {
		my $help = qq{
			Operations available:

			cd DIR        change working directory
			del FILE      remove file
			dir [MASK]    list all or matching files
			rename F1 F2  rename file
		};
		$help =~ s/^\n//; $help =~ s/^\t{2}\t?//mg;
		print $help;
	},
);

my %aliases = (
	chdir => 'cd',
	rm => 'del',
	find => 'dir',
);

print "Connected to $share_uri. Files:\n";
for my $file (@{$tree->find("*")}) {
	printf "%-40s %s\n", $file->name, $file->mtime_string;
}

while (1) {
	my $op = prompt("smb> ", 2);
	$op = $aliases{$op} if $aliases{$op};
	my $func = $operations{$op};
	if ($func) {
		$func->();
	} else {
		print "Invalid operation, try 'help'\n";
	}
}

